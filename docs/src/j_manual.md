# User manual

## Why Multitaper?

The [multitaper method](https://ieeexplore.ieee.org/abstract/document/1456701) is a 
widely used set of methods for nonparametric estimation of frequency domain 
quantities relevant to time series such as the power spectrum, coherence, and
transfer function. For an accessible introduction to multitaper methods, we recommend
[(Park, Lindberg, and Vernon,
1987)](https://agupubs.onlinelibrary.wiley.com/doi/abs/10.1029/JB092iB12p12675).

## Structs

[Multitaper.jl](bitbucket.org/clhaley/multitaper.jl) outputs spectra, coherences,
transfer functions, etc. in the form of Julia structs. The main reason for this is in
the ease of [Plotting](@ref Plotting).

The basic frequency domain structs are

 - [`MTSpectrum`](@ref)
 - [`MTCoherence`](@ref) 
 - [`MTTransferFunction`](@ref)

where MT signifies that these are multitaper estimates. Under the hood, one will find
the above structs may contain the following 

 - [`EigenCoefficient`](@ref)
 - [`MTParameters`](@ref).

Finally, one may be interested in computing the following time domain quantities

 - [`Demodulate`](@ref)
 - [`MTAutocorrelationFunction`](@ref) 
 - [`MTAutocovarianceFunction`](@ref)
 - [`MTCepstrum`](@ref)
 - [`MtCrossCovarianceFunction`](@ref) 
 - [`MTCrossCorrelationFunction`](@ref).

Below we expand on these basic structs.

### `MTSpectrum`

The `MTSpectrum` struct contains a multitaper spectrum estimate which consists of 
the following fields:
 
 - `f` is the range of frequencies
 - `S` contains the spectrum estimate
 - `phase` contains the vector of phases, if this is a cross-spectrum, and otherwise
   nothing.
 - `params` is a [`MTParameters`](@ref) struct which stores the choice of bandwidth
   and other quantities for the multitaper.
 - `coef` is a [`Eigencoefficient`](@ref) struct which stores the intermediate values
   of the calculation, if desired. These may be useful for subsequent calculations.
 - `Fpval` is the vector of F-test p-values at every frequency, see  
  [(Thomson, 1982)](https://ieeexplore.ieee.org/abstract/document/1456701).
 - `jkvar` is the vector of jackknifed variance estimates at every frequency.
 - `Tsq_pval` contains the result of a $T^2$ test for multiple lines, if requested.
   This field otherwise contains `nothing`. 

The `MTSpectrum` struct is generated by the function `multispec` when called on a
time series

```@repl example
using Multitaper, Plots
x = rand(100); # A time series consisting of 100 random points
S = multispec(x); # Compute the multitaper spectrum of the data using NW = 4
typeof(S)
plot(S)
```

There is an IJulia.jl notebook in 
[`Multitaper.jl/Examples/01_basic_multitaper.ipynb`](https://bitbucket.org/clhaley/multitaper.jl/src/master/Examples/01_basic_multitaper.ipynb?at=master&viewer=nbviewer) 
showing an example taken from the excellent text 
[(Percival and Walden, 1993)](https://faculty.washington.edu/dbp/sapabook.html). To
run this notebook on a cloned copy of the repo, follow the instructions in 
[Examples](@ref). 

The `multispec` function, when run on a single time series, additionally allows one 
to compute the following quantities:

 - F-test p-value, by setting the kwarg `Fpval = true`. This tests for a spectral
   line at every frequency. 
 - T-squared test p-value [(Thomson, 2011)](https://ieeexplore.ieee.org/document/6190385)

An example of the former are available in the [`Multitaper.jl/Examples/01_basic_multitaper.ipynb`](https://bitbucket.org/clhaley/multitaper.jl/src/master/Examples/01_basic_multitaper.ipynb?at=master&viewer=nbviewer)
notebook. 

The main advantage of the multitaper spectrum is that one can simultaneously control
the bias and variance of the estimator by varying the time-bandwidth product, $NW$.
This parameter is used to compute the multiple orthogonal tapers, see
[dpss_tapers](@ref), on which the method depends. When one computes the multitaper
spectrum, this parameter, along with a number of other quantities is given in the
output in the form of a `MTParameters` struct. 

#### `MTParameters`

This struct holds the following quantities

 - `NW` which is the chosen time-bandwidth product of the estimator. See [(Haley and
   Anitescu, 2017)](https://ieeexplore.ieee.org/abstract/document/7968365) for some 
  comments on optimal choice of $NW$. 
 - `K` which is the number of tapers. One typically chooses $K <= 2NW$ as the
   eigenvalue problem that gives the tapers has only $2NW$ large eigenvalues. For
   details on discrete prolate spheroidal sequences, which are used as data tapers,
   consult [dpss_tapers](@ref) and 
   [(Slepian, 1978)](https://onlinelibrary.wiley.com/doi/abs/10.1002/j.1538-7305.1978.tb02104.x). 
 - `N` which is the number of data points in the time series.
 - `dt` is the sampling interval, typically in seconds. 
 - `M` is the length of the output spectrum, usually different from $N$ because of
   zero-padding.
 - `nsegments` is the number of data blocks that have been made from the time series.
   When one calls [`multispec`](@ref), `nsegments` is one, but if one has called
   [`welch`](@ref), one can control the number of segments using the keyword argument of the
   same name.
 - `overlap` is the proportion of data by which the segments overlap, which is set to
   `nothing` if there is only one segment, but by default is `0.5` if one uses the
   [`welch`](@ref) method. 

These quantities are important when plotting, as they give indicators of the
resolution of the estimate, as indicated by a small cross-shape in the plotted
spectrum. See notebooks in [Examples](@ref) and [Plotting](@ref) for details.

Finally, if one selects the value `true` for the keyword argument `guts`, then the
intermediate values of the multitaper calculation are returned as well. These
intermediate values are eigencoefficients.

#### `EigenCoefficient`

The struct containing eigencoefficients has two fields 

 - `coef` the complex-valued tapered Fourier transformed data, and
 - `wts` which are the result of an adaptive weighting calculation, which are only
   computed if `a_weight` is set to `true` in a call to `multispec`. 
  (See [(Thomson, 1982)](https://ieeexplore.ieee.org/abstract/document/1456701) for
  the optional adaptive weighting procedure).

For details of the additional keyword arguments relevant to `multispec`, see
[multispec](@ref) entry in index.

### `MTCoherence`

The documentation is currently under construction as of 11/02/2020. 

### `MTTransf`


Finally, we come to the time doomain structs, which are indexed by lag.

### `Demodulate`

### `MTAutocorrelationFunction` 

### `MTAutocovarianceFunction`

### `MTCepstrum`

### `MtCrossCovarianceFunction` 

### `MTCrossCorrelationFunction`

